<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>bugbugz 지도</title>
  <style>
    html, body { margin: 0; padding: 0; height: 100%; }
    #map { width: 100%; height: 100%; }

    #infoBox {
      position: absolute;
      bottom: 10px;
      right: 10px;
      background-color: rgba(0,0,0,0.6);
      color: white;
      padding: 8px 12px;
      border-radius: 8px;
      font-family: sans-serif;
      font-size: 14px;
      z-index: 10;
    }

    /* 중앙 스피너 + 화면 블러 */
    #loadingOverlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.5);
      display: none;
      justify-content: center;
      align-items: center;
      z-index: 1000;
      pointer-events: all; /* 오버레이 활성화되면 아래 조작 막음 */
    }

    #loadingSpinner {
      width: 45px;
      height: 45px;
      border: 5px solid rgba(255, 255, 255, 0.4);
      border-top-color: #ffffff;
      border-radius: 50%;
      animation: spin 0.9s linear infinite;
    }

    @keyframes spin {
      from { transform: rotate(0deg); }
      to { transform: rotate(360deg); }
    }
  </style>
</head>
<body>

  <div id="map">
    <button id="currentLocationBtn"
      style="
        position: absolute;
        top: 30px;
        right: 20px;
        z-index: 10;
        padding: 8px 12px;
        border-radius: 6px;
        border: none;
        background-color: #4285f4;
        color: white;
        font-weight: bold;
        display: flex;
        flex-direction: column; /* 세로 방향 */
        align-items: center;
        justify-content: center;
        gap: 4px;
        cursor: pointer;
        box-shadow: 0 4px 6px rgba(0,0,0,0.3);">
      <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
        <path d="M22 11.25H19.96C19.6 7.44 16.56 4.39 12.75 4.04V2C12.75 1.59 12.41 1.25 12 1.25C11.59 1.25 11.25 1.59 11.25 2V4.04C7.44 4.4 4.39 7.44 4.04 11.25H2C1.59 11.25 1.25 11.59 1.25 12C1.25 12.41 1.59 12.75 2 12.75H4.04C4.4 16.56 7.44 19.61 11.25 19.96V22C11.25 22.41 11.59 22.75 12 22.75C12.41 22.75 12.75 22.41 12.75 22V19.96C16.56 19.6 19.61 16.56 19.96 12.75H22C22.41 12.75 22.75 12.41 22.75 12C22.75 11.59 22.41 11.25 22 11.25ZM12 15.12C10.28 15.12 8.88 13.72 8.88 12C8.88 10.28 10.28 8.88 12 8.88C13.72 8.88 15.12 10.28 15.12 12C15.12 13.72 13.72 15.12 12 15.12Z" fill="#ffffff"/>
      </svg>
      현재 위치
    </button>
  </div>

  <!-- 전체 화면 오버레이 + 중앙 스피너 -->
  <div id="loadingOverlay">
    <div id="loadingSpinner"></div>
  </div>

  <div id="infoBox"></div> <!-- 좌표 및 반경 표시 -->

  <script src="https://dapi.kakao.com/v2/maps/sdk.js?appkey=e31443337f00b1a3784da4be4a51b65b&autoload=false"></script>

  <script>
    kakao.maps.load(function () {

      // 초기값 (앱에서 전달받을 수 있음)
      const initialLat = 37.5665;
      const initialLng = 126.9780;
      const initialRadius = 500;

      const url = new URL(window.location.href);
      const lat = parseFloat(url.searchParams.get("lat")) || initialLat;
      const lng = parseFloat(url.searchParams.get("lng")) || initialLng;
      const radius = parseFloat(url.searchParams.get("radius")) || initialRadius;

      const map = new kakao.maps.Map(document.getElementById('map'), {
        center: new kakao.maps.LatLng(lat, lng),
        level: 5,
        draggable: true,
        scrollwheel: true
      });

      const marker = new kakao.maps.Marker({ position: map.getCenter(), map: map });

      let circle = new kakao.maps.Circle({
        center: map.getCenter(),
        radius: radius,
        strokeWeight: 2,
        strokeColor: '#FF0000',
        strokeOpacity: 0.7,
        strokeStyle: 'dashed',
        fillColor: '#FF0000',
        fillOpacity: 0.2,
        map: map
      });

      const infoBox = document.getElementById('infoBox');
      // 초기 표시
      infoBox.innerHTML = `좌표: ${lat.toFixed(6)}, ${lng.toFixed(6)}<br>반경: ${radius}m`;

      // 중앙 변경 이벤트
      function updateCenter() {
        const center = map.getCenter();
        marker.setPosition(center);
        circle.setOptions({ center });

        // 좌표값만 업데이트
        infoBox.innerHTML = `좌표: ${center.getLat().toFixed(6)}, ${center.getLng().toFixed(6)}<br>반경: ${radius}m`;
      }

      kakao.maps.event.addListener(map, 'center_changed', updateCenter);
      kakao.maps.event.addListener(map, 'dragend', updateCenter);

      document.addEventListener("message", function(event) {
        let data;
        try {
          data = JSON.parse(event.data);
        } catch (e) {
          console.error("Invalid message data", e);
          return;
        }

        if (data.type === 'REQUEST_LOCATION') {
          const center = map.getCenter();
          const payload = {
            lat: center.getLat(),
            lng: center.getLng()
          };
          window.ReactNativeWebView.postMessage(JSON.stringify(payload));
        }

        if (data.type === 'CURRENT_LOCATION') {
          const { latitude, longitude } = data;

          const newCenter = new kakao.maps.LatLng(latitude, longitude);
          map.setCenter(newCenter);
          marker.setPosition(newCenter);
          circle.setOptions({ center: newCenter });
          infoBox.innerHTML = `좌표: ${latitude.toFixed(6)}, ${longitude.toFixed(6)}<br>반경: ${radius}m`;
        }
      });

      const currentLocationBtn = document.getElementById('currentLocationBtn');
      const loadingOverlay = document.getElementById('loadingOverlay');

      currentLocationBtn.addEventListener('click', async () => {
        loadingOverlay.style.display = 'flex';

        if (navigator.geolocation) {
          navigator.geolocation.getCurrentPosition(
            (position) => {
              const { latitude, longitude } = position.coords;

              const newCenter = new kakao.maps.LatLng(latitude, longitude);
              map.setCenter(newCenter);
              marker.setPosition(newCenter);
              circle.setOptions({ center: newCenter });

              infoBox.innerHTML =
                `좌표: ${latitude.toFixed(6)}, ${longitude.toFixed(6)}<br>반경: ${radius}m`;

              loadingOverlay.style.display = 'none';
            },
            () => {
              alert('현재 위치를 가져올 수 없습니다. 위치 권한을 확인하세요.');
              loadingOverlay.style.display = 'none';
            },
            { enableHighAccuracy: true }
          );
        } else {
          alert('브라우저에서 위치 정보를 지원하지 않습니다.');
          loadingOverlay.style.display = 'none';
        }
      });
      
    });

  </script>
</body>
</html>
